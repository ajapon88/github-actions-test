name: pullrequest comment hook trigger

on:
  issue_comment:

jobs:
  pr_comment_trigger:
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.pull_request }}
    env:
      TRIGGER_PHRASE: test this please
    outputs:
      triggerd: ${{ steps.check_trigger_phrase.outputs.triggerd }}
      number: ${{ steps.metadata.outputs.number }}
      body: ${{ steps.metadata.outputs.body }}
      user: ${{ steps.metadata.outputs.user }}
      ref: ${{ steps.metadata.outputs.ref }}
      title: ${{ steps.metadata.outputs.title }}
      description: ${{ steps.metadata.outputs.description }}
    steps:
      - name: check trigger phrase
        id: check_trigger_phrase
        run: |
          if $(echo "${{ github.event.comment.body }}" | grep -e "${{ env.TRIGGER_PHRASE }}" > /dev/null); then
            echo "match trigger phrase"
            echo "::set-output name=triggerd::true"
          else
            echo "::set-output name=triggerd::false"
          fi
      - name: metadata
        id: metadata
        if: steps.check_trigger_phrase.outputs.triggerd == 'true'
        run: |
          echo "::set-output name=number::${{ github.event.issue.number }}"
          echo "::set-output name=body::${{ github.event.comment.body }}"
          echo "::set-output name=user::${{ github.event.comment.user.login }}"
          echo "::set-output name=ref::${{ github.event.issue.pull_request.head.ref }}"
          echo "::set-output name=title::${{ github.event.issue.pull_request.title }}"
          echo "::set-output name=description::${{ github.event.issue.pull_request.body }}"

  triggered_action:
    runs-on: ubuntu-latest
    if: needs.pr_comment_trigger.outputs.triggerd == 'true'
    needs:
      - pr_comment_trigger
    steps:
      - name: comment pullrequest
        uses: actions/github-script@v3
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.issues.createComment({
              issue_number: ${{ needs.pr_comment_trigger.outputs.number }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '${{ needs.pr_comment_trigger.outputs.body }}'
            })
